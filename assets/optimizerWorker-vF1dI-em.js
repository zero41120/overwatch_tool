var Dt=Object.defineProperty;var Bt=(f,b,x)=>b in f?Dt(f,b,{enumerable:!0,configurable:!0,writable:!0,value:x}):f[b]=x;var i=(f,b,x)=>Bt(f,typeof b!="symbol"?b+"":b,x);(function(){"use strict";class f{static resolveInputs(e={}){const s={};return this.inputs.forEach(r=>{const n=e[r.id];if(r.type==="number"){let a=typeof n=="number"?n:r.defaultValue;r.min!==void 0&&(a=Math.max(r.min,a)),r.max!==void 0&&(a=Math.min(r.max,a)),s[r.id]=a}else s[r.id]=typeof n=="boolean"?n:r.defaultValue}),s}evaluateWithDefaults(e={}){const r=this.constructor.resolveInputs(e);return this.evaluate(r)}}i(f,"id"),i(f,"label"),i(f,"description"),i(f,"hero"),i(f,"inputs",[]),i(f,"outputs",[]);const b=["WP","AS","Weapon Multiplier","MA","AP"],x="CODEBREAKER",Q="Stinger";function tt(t){return t.some(e=>e.name.toUpperCase()===x)}function et(t,e){const n=Math.min(e?3.5:7,t*(e?.25:.5));return t-n}function st({bulletValue:t=7.5,weaponPower:e=100,attackSpeed:s=100,clipSize:r=180,withReload:n=!0,items:a=[],enemyHasArmor:c=!1}){const o=n?90:0,l=.3*60,p=.45*60,I=.03*60,d=12,m=s/100,_=e/100,w=Math.ceil(l/m);let y=o+w;const D=Math.ceil(p/m);for(let h=1;h<=r;h++){(h-1)%d===0||(y+=I);const B=h%d===0,Tt=h<r;B&&Tt&&(y+=D)}const O=t*_,N=c&&O>0?et(O,tt(a)):O;return r*N*(60/y)}function rt(t,e){return t!=null&&t.length?t.some(s=>s.toLowerCase()===e.toLowerCase()):!1}function F({map:t,bullet:e=7.5,items:s=[],enemyHasArmor:r=!1,withReload:n=!0}){const a=100+(t.get("WP")??0),c=1+(t.get("Weapon Multiplier")??0)/100,u=100+(t.get("AS")??0),l=1+(t.get("MA")??0)/100,p=Math.max(1,Math.round(180*l));return Number(st({bulletValue:e*c,weaponPower:a,attackSpeed:u,clipSize:p,withReload:n,items:s,enemyHasArmor:r}).toFixed(0))}const K="juno-mediblaster";class E extends f{constructor(s){super();i(this,"context");this.context=s}static getOptimizerExtraFields(s){return s.enemyHasArmor?[{id:"mediblaster-codebreaker",combine:"max",itemValue:r=>r.name.toUpperCase()===x?1:0}]:[]}evaluate(s){const r=this.context.items.map(_=>({name:_.name})),n=!!s.enemyHasArmor,a=F({map:this.context.map,items:r,enemyHasArmor:n,withReload:!1}),c=F({map:this.context.map,items:r,enemyHasArmor:n,withReload:!0}),o=Number(s.weaponAccuracy??35)/100,l=a*o,p=c*o,I=!!s.includeReloadDowntime;let d=p;I||(d=l);const m=rt(this.context.heroPowers,Q)?10*(1+(this.context.map.get("AP")??0)/100):0;return{burst:Math.round(l+m),sustain:Math.round(d+m)}}}i(E,"id",K),i(E,"label","Mediblaster"),i(E,"description","Juno mediblaster output with and without reload downtime."),i(E,"hero","Juno"),i(E,"inputAttributes",b),i(E,"inputs",[{id:"enemyHasArmor",label:"Enemy Has Armor",type:"bool",defaultValue:!1,description:"Apply armor reduction (Codebreaker mitigates the reduction)."},{id:"includeReloadDowntime",label:"Include Reload Downtime",type:"bool",defaultValue:!0,description:"When enabled, sustain output includes reload downtime."},{id:"weaponAccuracy",label:"Weapon Accuracy (%)",type:"number",defaultValue:35,min:0,max:100,step:1,description:"Scales mediblaster DPS by the expected accuracy percentage."}]),i(E,"outputs",[{id:"burst",label:"Burst Output",unit:"burst",description:"Burst output without reload downtime."},{id:"sustain",label:"Sustain Output",unit:"sustain",description:"Sustained output including reload downtime."}]);var nt=Object.freeze({__proto__:null,JUNO_MEDIBLASTER_METRIC_ID:K,JunoMediblasterMetric:E,MEDIBLASTER_INPUT_ATTRS:b,computeMediblasterOutputFromMap:F});function g(t){const e=t.match(/[-+]?\d+(?:\.\d+)?/);return e?parseFloat(e[0]):0}const v=85,at={"PULSTAR DESTROYERS":{situational:!0},"MARK OF THE KITSUNE":{situational:!0},"SKYLINE NANITES":{situational:!0},CYBERVENOM:{situational:!0}};function ot(t){const e=t.match(/stat-ap\">(\d+(?:\.\d+)?)/g);return e?e.reduce((s,r)=>{const n=r.match(/(\d+(?:\.\d+)?)/);return s+(n?Number(n[1]):0)},0):0}function L(t){let e=0,s=0,r=0,n=0,a=0,c=0,u=0;t.attributes.forEach(l=>{switch(l.type){case"AP":e+=g(l.value);break;case"WP":n+=g(l.value);break;case"ALS":case"WPLS":a+=g(l.value);break;case"Health":r+=g(l.value);break;case"Shield":case"Shields":u+=g(l.value);break;case"Armor":c+=g(l.value);break;case"description":s+=ot(l.value);break}});const o=at[t.name];return{id:t.id??t.name,name:t.name,cost:t.cost,ap:e+((o==null?void 0:o.addAp)??0),baseAdd:s+((o==null?void 0:o.addBaseAdd)??0),hp:r+((o==null?void 0:o.addHp)??0),wp:n+((o==null?void 0:o.addWp)??0),lifesteal:a+((o==null?void 0:o.addLifesteal)??0),dr:c+((o==null?void 0:o.addDr)??0),hps:u+((o==null?void 0:o.addHps)??0),situational:!!(o!=null&&o.situational)}}function ct(t,e=v){let s=0,r=0,n=!1;t.forEach(u=>{const o=L(u);s+=o.ap,r+=o.baseAdd,/^skyline\s+nanites$/i.test(u.name.toLocaleLowerCase())&&(n=!0)});const c=(e+r)*(1+s/100);return Number((n?c*1.2:c).toFixed(0))}const k="juno-torpedo",W=10;class A extends f{constructor(s){super();i(this,"context");this.context=s}static getOptimizerExtraFields(){return[{id:"torpedo-base-add",combine:"sum",itemValue:s=>L(s).baseAdd},{id:"torpedo-skyline",combine:"max",itemValue:s=>/^skyline\s+nanites$/i.test(s.name)?1:0}]}evaluate(s){const r=Number(s.baseDamage??v),n=ct(this.context.items,r),a=Math.max(.1,Number(s.cooldownSeconds??W));return{burst:n,sustain:n/a}}}i(A,"id",k),i(A,"label","Torpedoes"),i(A,"description","Pulsar Torpedo damage with burst and cooldown-adjusted sustain."),i(A,"hero","Juno"),i(A,"inputAttributes",["AP"]),i(A,"inputs",[{id:"baseDamage",label:"Base Torpedo Damage",type:"number",defaultValue:v,min:0,step:1,description:"Base damage before AP scaling or item additions."},{id:"cooldownSeconds",label:"Cooldown (Seconds)",type:"number",defaultValue:W,min:.1,step:.1,description:"Cooldown used to compute sustained output."}]),i(A,"outputs",[{id:"burst",label:"Burst Damage",unit:"burst",description:"Single-hit torpedo damage."},{id:"sustain",label:"Sustain DPS",unit:"sustain",description:"Average damage per second based on cooldown."}]);var ut=Object.freeze({__proto__:null,JUNO_TORPEDO_METRIC_ID:k,JunoTorpedoMetric:A});const U="raw",j="Raw Stats";function it(t,e){S.outputs=t.map(s=>({id:s,label:e(s),unit:"raw"}))}class S extends f{constructor(s){super();i(this,"context");this.context=s}evaluate(){const s={};return this.constructor.outputs.forEach(n=>{s[n.id]=this.context.map.get(n.id)??0}),s}}i(S,"id",U),i(S,"label",j),i(S,"inputs",[]),i(S,"outputs",[]);var lt=Object.freeze({__proto__:null,RAW_METRIC_ID:U,RAW_METRIC_LABEL:j,RawStatMetric:S,setRawStatMetricOutputs:it});function dt(t){if(typeof t!="function")return!1;const e=t;return typeof e.id=="string"&&typeof e.label=="string"&&Array.isArray(e.inputs)&&Array.isArray(e.outputs)&&typeof e.resolveInputs=="function"}function mt(t){const e=[];return Object.keys(t).length===0?(console.warn("[metrics] No metric modules found via auto-discovery"),e):(Object.entries(t).forEach(([s,r])=>{if(s.includes("/__tests__/")||s.endsWith("ComputedMetric.ts"))return;const a=Object.values(r??{}).filter(dt);if(a.length===0){console.warn(`[metrics] No metric class found in ${s}`);return}a.forEach(c=>e.push(c))}),e)}const z="metric:",ft="raw",C=mt(Object.assign({"../JunoMediblasterMetric.ts":nt,"../JunoTorpedoMetric.ts":ut,"../RawStatMetric.ts":lt}));function H(t,e){return t.hero?Array.isArray(t.hero)?t.hero.includes(e):t.hero===e:!0}function M(t,e){return t===ft?e:`${z}${t}:${e}`}function pt(t){return t.startsWith(z)}function ht(t){const e=new Set(t),s=new Set;return C.forEach(r=>{var a;r.outputs.map(c=>M(r.id,c.id)).some(c=>e.has(c))&&((a=r.inputAttributes)==null||a.forEach(c=>s.add(c)))}),s}function bt(t,e,s){const r=new Map;return C.forEach(n=>{if(!H(n,t.hero))return;const a=n.outputs.map(o=>M(n.id,o.id));if(e&&!a.some(o=>e.has(o)))return;const u=new n(t).evaluateWithDefaults((s==null?void 0:s[n.id])??{});n.outputs.forEach(o=>{const l=M(n.id,o.id);e&&!e.has(l)||r.set(l,u[o.id]??0)})}),r}function Et(t,e,s){const r=[];return C.forEach(n=>{if(!H(n,t)||!n.outputs.map(o=>M(n.id,o.id)).some(o=>e.has(o))||typeof n.getOptimizerExtraFields!="function")return;const c=n.resolveInputs((s==null?void 0:s[n.id])??{}),u=n.getOptimizerExtraFields(c);u!=null&&u.length&&u.forEach(o=>r.push(o))}),r}const gt=new Set(["description","Editor's Note"]);function At(t){const e=new Map;return t.forEach(s=>{s.attributes.forEach(r=>{if(gt.has(r.type))return;const n=g(r.value);e.set(r.type,(e.get(r.type)??0)+n)})}),e}function V(t,e,s={}){const r=At(t),n=new Map(r);if(s.metricOutputKeys&&s.metricOutputKeys.size>0){const a={items:t,map:r,hero:e??"",heroPowers:s.heroPowers};bt(a,s.metricOutputKeys,s.metricInputValues).forEach((u,o)=>n.set(o,u))}return n}function q(t,e){let s=0;return e.forEach(r=>{s+=(t.get(r.type)??0)*r.weight}),s}function G(t){const e={};return t.forEach((s,r)=>{e[r]=s}),e}function $(t,e,s,r={}){const n=V(t,s,r);return e.every(a=>a.attrs.reduce((u,o)=>u+(n.get(o)??0),0)>=a.value)}function It(t,e,s){const r=new Set(t.map(a=>a.type));return ht(r).forEach(a=>r.add(a)),Array.from(r).forEach(a=>{pt(a)&&r.delete(a)}),e&&s.forEach(a=>{a.attrs.forEach(c=>r.add(c))}),r.delete(""),r}const T=1e-9;function yt(t,e){return e.map(s=>s.itemValue(t))}function xt(t,e,s,r){const n=Array(e.length).fill(0);return t.attributes.forEach(a=>{const c=s.get(a.type);c!==void 0&&(n[c]+=g(a.value))}),{cost:t.cost,attrs:n,extras:yt(t,r)}}function Y(t,e,s){let r=!1;for(let n=0;n<t.attrs.length;n+=1){if(t.attrs[n]+T<e.attrs[n])return!1;t.attrs[n]>e.attrs[n]+T&&(r=!0)}for(let n=0;n<s;n+=1){if(t.extras[n]+T<e.extras[n])return!1;t.extras[n]>e.extras[n]+T&&(r=!0)}return r}function X(t,e){const s=t.attrs.reduce((n,a)=>n+a,0);let r=0;for(let n=0;n<e;n+=1)r+=t.extras[n];return s+r}function _t(t,e,s){var n;const r=((n=s.extraFields)==null?void 0:n.length)??0;for(const a of t)if(Y(a,e,r))return;for(let a=t.length-1;a>=0;a-=1)Y(e,t[a],r)&&t.splice(a,1);t.push(e),s.maxFrontier!==void 0&&t.length>s.maxFrontier&&(t.sort((a,c)=>X(c,r)-X(a,r)),t.length=s.maxFrontier)}function St(t,e){const s=Math.floor(e.maxCash/e.costStep);if(s<0)return[];const r=new Map;e.attrKeys.forEach((d,m)=>r.set(d,m));const n=e.extraFields??[],a=t.map(d=>xt(d,e.attrKeys,r,n)),c=n.length,u=e.onProgress,o=a.length,l=Math.max(1,e.progressInterval??25);u&&u({phase:"profiles",completed:0,total:o});const p=Array.from({length:e.maxItems+1},()=>Array.from({length:s+1},()=>[]));p[0][0]=[{cost:0,attrs:Array(e.attrKeys.length).fill(0),extras:Array(c).fill(0),indices:[]}],a.forEach((d,m)=>{const _=Math.ceil(d.cost/e.costStep);if(_<=s)for(let w=e.maxItems;w>=1;w-=1)for(let y=s;y>=_;y-=1){const D=p[w-1][y-_];if(D.length===0)continue;const O=p[w][y];for(const P of D){const N=P.attrs.map((h,R)=>h+d.attrs[R]),J=P.extras.map((h,R)=>{const B=n[R];return B?B.combine==="max"?Math.max(h,d.extras[R]??0):h+(d.extras[R]??0):h});_t(O,{cost:P.cost+d.cost,attrs:N,extras:J,indices:[...P.indices,m]},e)}}u&&((m+1)%l===0||m+1===o)&&u({phase:"profiles",completed:m+1,total:o})});const I=[];for(let d=0;d<=e.maxItems;d+=1)for(let m=0;m<=s;m+=1)I.push(...p[d][m]);return I}function Z(t){const e=t.selectedMetricOutputs;if(t.maxItems===0){const n=V(t.equippedItems,t.hero,{metricOutputKeys:e,metricInputValues:t.metricInputValues,heroPowers:t.heroPowers}),a=G(n);return t.minValueEnabled&&!$(t.equippedItems,t.minAttrGroups,t.hero,{metricInputValues:t.metricInputValues,heroPowers:t.heroPowers})?[]:[{items:[],cost:0,score:q(n,t.weights),metricValues:a,breakdown:[]}]}const s=St(t.items,{maxItems:t.maxItems,maxCash:t.maxCash,costStep:t.costStep??250,maxFrontier:t.maxFrontier,attrKeys:t.attrKeys,extraFields:t.extraFields,onProgress:t.onProgress,progressInterval:t.progressInterval}),r=[];return s.forEach(n=>{if(n.cost>t.maxCash)return;const a=n.indices.map(o=>t.items[o]),c=[...a,...t.equippedItems];if(t.minValueEnabled&&!$(c,t.minAttrGroups,t.hero,{metricInputValues:t.metricInputValues,heroPowers:t.heroPowers}))return;const u=V(c,t.hero,{metricOutputKeys:e,metricInputValues:t.metricInputValues,heroPowers:t.heroPowers});r.push({items:a,cost:n.cost,score:q(u,t.weights),metricValues:G(u),breakdown:[]})}),r}function wt(t){const e=Z(t);if(e.length===0)return[];let s=-1/0;const r=[];return e.forEach(n=>{if(n.score>s){s=n.score,r.length=0,r.push(n);return}n.score===s&&r.push(n)}),r}function Rt(t){const e=Z(t).sort((c,u)=>c.cost-u.cost);if(e.length===0)return[];const s=[];let r=-1/0,n=[],a=0;return t.budgets.forEach(c=>{for(;a<e.length&&e[a].cost<=c;){const u=e[a];u.score>r?(r=u.score,n=[u]):u.score===r&&n.push(u),a+=1}n.length>0&&s.push(...n)}),s}function Ot(t){const e=new Set;return t.forEach(s=>{s.attributes.forEach(r=>{e.add(r.type)})}),e}function Pt({items:t,weights:e,selectedMetricOutputs:s,metricInputValues:r,minValueEnabled:n,minAttrGroups:a,hero:c}){const u=It(e,n,a),o=Ot(t),l=Array.from(u).filter(I=>o.has(I)),p=[];return s.size>0&&p.push(...Et(c??"",s,r)),{attrKeys:l,extraFields:p}}function Mt(t){const e=n=>{const a={type:"progress",requestId:t.requestId,progress:n};self.postMessage(a)},s=Pt({items:t.options.items,weights:t.options.weights,selectedMetricOutputs:t.options.selectedMetricOutputs,metricInputValues:t.options.metricInputValues,minValueEnabled:t.options.minValueEnabled,minAttrGroups:t.options.minAttrGroups,hero:t.options.hero,heroPowers:t.options.heroPowers}),r={...t.options,attrKeys:s.attrKeys,extraFields:s.extraFields,onProgress:e,progressInterval:t.progressInterval};return t.mode==="incremental"?Rt({...r,budgets:t.budgets??[]}):wt(r)}self.onmessage=t=>{const e=t.data;try{const s=Mt(e),r={type:"result",requestId:e.requestId,results:s};self.postMessage(r)}catch(s){const r={type:"error",requestId:e.requestId,error:s instanceof Error?s.message:String(s)};self.postMessage(r)}}})();
